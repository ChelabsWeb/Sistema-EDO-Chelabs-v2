# Epic 6 Retrospective: Financial Control & Deviation Alerts

## Status: Done
## Date: 2025-12-19

## Epic Summary

**Epic 6: Financial Control & Deviation Alerts** implemented complete financial visibility:
- Story 6-1: Calculate Real OT Cost (Done)
- Story 6-2: Calculate and Display Deviation (Done - pre-existing)
- Story 6-3: Aggregate Deviation by Rubro (Done)
- Story 6-4: Visual Deviation Alerts (Done)
- Story 6-5: Close OT with Deviation Acknowledgment (Done)

**Functional Requirements Covered:** FR33-FR37

## Delivery Metrics

| Metric | Value |
|--------|-------|
| Stories Completed | 5/5 (100%) |
| Build Status | All passed |
| Duration | Same day |
| Technical Debt | None added |

## Key Accomplishments

### 1. Cost Calculation Engine (Story 6-1)

Created centralized cost calculation module `src/app/actions/costos.ts`:
- `calculateOTCostoReal(otId)` - Calculates from consumo_materiales
- `updateOTCostoReal(otId)` - Updates OT and revalidates paths
- `getOTCostSummary(otId)` - Returns complete cost summary
- `getDeviationsByRubro(obraId)` - Aggregates deviations by rubro

**Price Priority Logic:**
1. lineas_oc.precio_unitario (OC purchase price) - weighted average if multiple
2. insumos.precio_unitario (catalog price) - fallback

### 2. Auto-Recalculation Triggers

Added automatic cost recalculation on:
- consumo_materiales insert/update/delete
- recepciones registration (updates affected OTs)

### 3. Visual Deviation Alerts (Story 6-4)

Dashboard:
- Deviation count banner with critical count
- Yellow/red styling based on severity

OT List:
- Warning/critical triangle icons
- Row background coloring (bg-yellow-50 / bg-red-50)
- Deviation column with amount and percentage

### 4. "Alertar, No Bloquear" Implementation (Story 6-5)

- Close modal shows deviation amount AND percentage
- Checkbox acknowledgment required before closing
- History records who acknowledged and when
- Badge in timeline: "Desvio reconocido por [nombre]"

## Technical Decisions

### Architecture

- Server actions pattern maintained (Result<T, E>)
- Centralized cost logic in single module
- Automatic triggers vs manual recalculation
- Re-used existing UI where possible (Story 6-2)

### Workaround Applied

**Issue:** FK join for `acknowledged_by` failed with Supabase PostgREST
```
SelectQueryError<"could not find the relation between ot_historial and usuarios">
```

**Solution:** Fetch acknowledged user with separate query when needed, optimize by reusing existing user when acknowledged_by === usuario_id

## Previous Epic Action Items Follow-Through

From Epic 5 Retrospective:
- ✅ FK indexes migration - Applied and working
- ✅ RLS policies optimized - Using (select auth.uid()) pattern
- ✅ Consolidated permissive policies - Done
- ⏭️ Leaked Password Protection - Skipped (requires Supabase Pro)

## Lessons Learned

1. **Pre-existing implementations are valuable** - Story 6-2 was already done, documented rather than duplicated
2. **Supabase FK joins can be tricky** - Not all FK relationships work with the hint syntax
3. **Session context limits** - Long epics may require continuation, summaries help
4. **Centralized modules scale** - costos.ts can easily extend for future financial features

## Files Created/Modified

**New Files:**
- `src/app/actions/costos.ts` - Cost calculation functions
- `src/components/edo/costos/rubro-deviations.tsx` - Aggregated deviations table

**Modified Files:**
- `src/app/actions/consumo-materiales.ts` - Auto-recalculation
- `src/app/actions/recepciones.ts` - Auto-recalculation for affected OTs
- `src/app/(dashboard)/dashboard/page.tsx` - Deviation alerts
- `src/app/(dashboard)/obras/[id]/page.tsx` - Rubro deviations section
- `src/app/(dashboard)/obras/[id]/ordenes-trabajo/page.tsx` - Visual alerts
- `src/app/(dashboard)/obras/[id]/ordenes-trabajo/[otId]/page.tsx` - Acknowledged user fetch
- `src/components/edo/ot/ot-actions.tsx` - Percentage in close modal
- `src/components/edo/ot/ot-history-timeline.tsx` - Enhanced acknowledgment display

## Next Epic Preparation

**Epic 7: Dashboard & Visibility** is ready to start.

Dependencies on Epic 6 (all ready):
- ✅ Deviation calculations via costos.ts
- ✅ Visual alert components
- ✅ Cost aggregation functions

No blocking issues or preparation tasks needed.

## Action Items

- [ ] Consider adding Supabase Pro for leaked password protection (optional)
- [ ] Monitor cost calculation performance as data grows
- [ ] Review FK join patterns if more complex relationships needed

---

**Retrospective Status:** Complete
**Next Step:** Begin Epic 7 with story creation
